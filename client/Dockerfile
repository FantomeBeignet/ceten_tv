ARG GOOGLE_CLIENT_ID
ARG GOOGLE_CLIENT_SECRET
ARG AUTH_SECRET
ARG NEXTAUTH_URL
ARG USER_WHITELIST

### Build Step
FROM node:19-alpine as build

WORKDIR /app

ARG GOOGLE_CLIENT_ID
ARG GOOGLE_CLIENT_SECRET
ARG AUTH_SECRET
ARG NEXTAUTH_URL
ARG USER_WHITELIST

ENV GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
ENV GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
ENV AUTH_SECRET=${AUTH_SECRET}
ENV NEXTAUTH_URL=${NEXTAUTH_URL}
ENV USER_WHITELIST=${USER_WHITELIST}
ENV AUTH_TRUST_HOST=true

COPY package*.json ./

RUN npm ci

COPY . .

RUN npm run build

### Serve Step
FROM node:19-alpine

WORKDIR /app

ARG GOOGLE_CLIENT_ID
ARG GOOGLE_CLIENT_SECRET
ARG AUTH_SECRET
ARG NEXTAUTH_URL
ARG USER_WHITELIST

ENV GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
ENV GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
ENV AUTH_SECRET=${AUTH_SECRET}
ENV NEXTAUTH_URL=${NEXTAUTH_URL}
ENV USER_WHITELIST=${USER_WHITELIST}
ENV AUTH_TRUST_HOST=true

COPY --from=build /app/build .
COPY --from=build /app/package.json .
COPY --from=build /app/node_modules ./node_modules

EXPOSE 3000

CMD ["node", "index.js"]